---
title: "Scraping and Analysis"
author: "Waleed Iftikhar and Sameer Swarup"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(tidyverse)
library(purrr)
library(survey)
library(forcats)
library(class)
library(readr)
library(tidyr)
library(randomForest)
library(caret)
library(partykit)
library(rpart)
```

*Scraping data from Wikipedia*
```{r}
#Reading in Wikipedia Page on Ronaldo vs Messi rivalry
wikiurl <- "https://en.wikipedia.org/wiki/Ronaldo%E2%80%93Messi_rivalry#Club_statistics"
wikipage <- read_html(wikiurl)
```

*Creating a dataset of club goals*
```{r}
#Extracting html table that has Messi and Ronaldo club goals
tables.html <- html_nodes(wikipage,"table")
clgls <- html_table(tables.html[[5]], fill = TRUE) %>% as_tibble()
```

*Creating a dataset of Messi Club Goals.*
```{r}
#Slicing tibble so that it has properly named columns and has data on Messi from 2008 to 2018
messiclgls <- clgls  %>%
  select(X1,X2,X3,X4,X5,X6,X7,X8,X9,X10,X11,X12)%>%
  slice(3:22)
messiclgls <- messiclgls %>%
  rename(Club = "X1", Season = "X2", LeagueApps = "X3", LeagueGoals = "X4", CupApps = "X5", CupGoals = "X6",EuropeApps = "X7", EuropeGoals = "X8",OtherApps = "X9", OtherGoals = "X10",TotalApps = "X11", TotalGoals = "X12" )
messiclgls <- messiclgls%>%
  slice(-(1:3))%>%
  slice(-17)
```

*Creating a dataset of Ronaldo Club Goals*
```{r}
#Slicing tibble so that is has properly named columns and has data on Ronaldo from 2008 to 2018
crisclgls <- clgls  %>%
  select(X1,X2,X3,X4,X5,X6,X7,X8,X9,X10,X11,X12)%>%
  slice(23:47)
crisclgls <- crisclgls %>%
  rename(Club = "X1", Season = "X2", LeagueApps = "X3", LeagueGoals = "X4", CupApps = "X5", CupGoals = "X6",EuropeApps = "X7", EuropeGoals = "X8",OtherApps = "X9", OtherGoals = "X10",TotalApps = "X11", TotalGoals = "X12" )
crisclgls <- crisclgls%>%
  slice(-(1:3))%>%
  drop_na()
```

*Creating a dataset of international goals*
```{r}
intgls <- html_table(tables.html[[8]], fill = TRUE) %>% as_tibble()
```

*Creating a dataset of Messi International Goals.*
```{r}
messiintgls <- intgls  %>%
  select(X1,X2,X3,X4,X5,X6,X7,X8)%>%
  slice(3:19)
messiintgls <- messiintgls %>%
  rename(NationalTeam= "X1", Year = "X2", CompApps= "X3", CompGoals = "X4", FrndApps = "X5", FrndGoals = "X6",TotalApps = "X7", TotalGoals = "X8")
messiintgls <- messiintgls%>%
  slice(-(1:2))
```

*Creating a dataset of Ronaldo International Goals.*
```{r}
crisintgls <- intgls  %>%
  select(X1,X2,X3,X4,X5,X6,X7,X8)%>%
  slice(23:41)
crisintgls <- crisintgls %>%
  rename(NationalTeam= "X1", Year = "X2", CompApps= "X3", CompGoals = "X4", FrndApps = "X5", FrndGoals = "X6",TotalApps = "X7", TotalGoals = "X8")
crisintgls <- crisintgls%>%
  slice(-(1:2))
```

*Scraping data from MessivsRonaldo.net*
```{r}
urlCalendar <- "https://messivsronaldo.net/calendar-year-stats/"
pageCalendar <- read_html(urlCalendar)
```

*Getting all nodes of type unordered list (ul)*
```{r}
div.html <- html_nodes(pageCalendar, "ul")
```
*Getting all of messi's and ronaldo's stats from the ul parent nodes*
```{r}
messi <- html_nodes(pageCalendar, ".messi.stats")
ronaldo <- html_nodes(pageCalendar, ".ronaldo.stats")
```

*Making tibble out of messi stats*
```{r}
messiStats <- tibble(
  apps = messi %>% html_node(".apps") %>% html_text(),
  assists = messi %>% html_node(".assists") %>% html_text(),
  goals = messi %>% html_node(".goals .num") %>% html_text()
)
```

*Making tibble out of ronaldo stats*
```{r}
ronaldoStats <- tibble(
  apps = ronaldo %>% html_node(".apps") %>% html_text(),
  assists = ronaldo %>% html_node(".assists") %>% html_text(),
  goals = ronaldo %>% html_node(".goals .num") %>% html_text()
)
```

*Cleaning data from the messiStats dataframe*
```{r}
messiStatsparse <- messiStats %>%
  mutate(apps = parse_number(apps), assists = parse_number(assists), goals = parse_number(goals))%>%
  mutate(type = rep(c("Total", "Club", "Country"), nrow(messiStats)/3))
```

*Filtering Apps, Assists, and Goals based on Total, Club and Country*
```{r}
MTotals <- messiStatsparse%>%
  filter(type == "Total")
MClubs <- messiStatsparse%>%
  filter(type == "Club")
MCountries <- messiStatsparse%>%
  filter(type == "Country")
```

```{r}
MTotals <- MTotals %>%
  select(apps,assists,goals) %>%
  rename(MTotApps = "apps", MTotAssists = "assists", MTotGoals = "goals" )%>%
  mutate(Year = rep(2020:2002))%>%
  select(Year, MTotApps, MTotAssists, MTotGoals)
```

```{r}
MClubs <- MClubs %>%
  select(apps,assists,goals) %>%
  rename(MClubApps = "apps", MClubAssists = "assists", MClubGoals = "goals" )%>%
  mutate(Year = rep(2020:2002))%>%
  select(Year, MClubApps, MClubAssists, MClubGoals)
```

```{r}
MCountries <- MCountries %>%
  select(apps,assists,goals) %>%
  rename(MCoApps = "apps", MCoAssists = "assists", MCoGoals = "goals" )%>%
  mutate(Year = rep(2020:2002))%>%
  select(Year, MCoApps, MCoAssists, MCoGoals)
```

```{r}
MessiPartial <- left_join(MTotals,MClubs, by = "Year")
MessiComplete <- left_join(MessiPartial, MCountries, by = "Year")
write_csv(MessiComplete, "MessiComplete.csv")
```

*Cleaning data from the ronaldoStats dataframe*
```{r}
ronaldoStatsparse <- ronaldoStats %>%
  mutate(apps = parse_number(apps), assists = parse_number(assists), goals = parse_number(goals))%>%
  mutate(type = rep(c("Total", "Club", "Country"), nrow(ronaldoStats)/3))
```

```{r}
RTotals <- ronaldoStatsparse%>%
  filter(type == "Total")
RClubs <- ronaldoStatsparse%>%
  filter(type == "Club")
RCountries <- ronaldoStatsparse%>%
  filter(type == "Country")
```

```{r}
RTotals <- RTotals %>%
  select(apps,assists,goals) %>%
  rename(RTotApps = "apps", RTotAssists = "assists", RTotGoals = "goals" )%>%
  mutate(Year = rep(2020:2002))%>%
  select(Year, RTotApps, RTotAssists, RTotGoals)
```

```{r}
RClubs <- RClubs %>%
  select(apps,assists,goals) %>%
  rename(RClubApps = "apps", RClubAssists = "assists", RClubGoals = "goals" )%>%
  mutate(Year = rep(2020:2002))%>%
  select(Year, RClubApps, RClubAssists, RClubGoals)
```

```{r}
RCountries <- RCountries %>%
  select(apps,assists,goals) %>%
  rename(RCoApps = "apps", RCoAssists = "assists", RCoGoals = "goals" )%>%
  mutate(Year = rep(2020:2002))%>%
  select(Year, RCoApps, RCoAssists, RCoGoals)
```

```{r}
RonaldoPartial <- left_join(RTotals,RClubs, by = "Year")
RonaldoComplete <- left_join(RonaldoPartial, RCountries, by = "Year")
write_csv(RonaldoComplete, "RonaldoComplete.csv")
```

*Joining the MessiComplete and RonaldoComplete Dataframes*
```{r}
StatsComplete <- inner_join(MessiComplete, RonaldoComplete, by = "Year")
```

*Datawrangling from Trophy_Comparison dataset*
```{r}
RonaldoTrophies <- Trophy_Comparison%>%
  filter(Player == "Ronaldo")
MessiTrophies <- Trophy_Comparison%>%
  filter(Player == "Messi")
```

```{r}
RonaldoTrophies1 <- RonaldoTrophies %>%
  select(Year, League, DomesticCup, EuropeanCup) %>%
  rename(RLeague = "League", RDomesticCup = "DomesticCup", REuropeanCup = "EuropeanCup")
MessiTrophies1 <- MessiTrophies %>%
  select(Year, League, DomesticCup, EuropeanCup) %>%
  rename(MLeague = "League", MDomesticCup = "DomesticCup", MEuropeanCup = "EuropeanCup")
```

```{r}
Trophies <- inner_join(MessiTrophies1, RonaldoTrophies1, by = "Year")
```

```{r}
WithoutAward <- inner_join(StatsComplete, Trophies, by = "Year")
```

```{r}
WithoutAwardFilter <- WithoutAward %>%
  filter(Year >= 2008 & Year != 2018)
```

```{r}
WithAward <- WithoutAwardFilter %>%
  mutate(BallonDor = c("Messi", "Ronaldo", "Ronaldo","Messi", "Ronaldo", "Ronaldo", "Messi", "Messi", "Messi", "Messi", "Ronaldo"))
write_csv(WithAward, "MessiRonaldoComplete.csv")
```


*Scraping data on Messi goals in competitions.*
```{r}
messiClubStatsURL <- "https://www.transfermarkt.us/lionel-messi/detaillierteleistungsdaten/spieler/28003"
```

```{r}
messiClubStatsPage <- read_html(messiClubStatsURL)
```

```{r}
messiTable.html <- html_nodes(messiClubStatsPage, "table")
```

```{r}
messiLaLiga <- html_table(messiTable.html[[1]], fill = TRUE) %>% as_tibble(.name_repair = "unique")

messiLaLiga <- messiLaLiga %>% select(Season, Club, ...6, ...7) %>% rename(Appearances = "Club", Goals = "...6", Assists = "...7") %>% drop_na() %>% slice(3:11)
messiLaLiga <- messiLaLiga %>%
  mutate(Player = "Messi")
```

*Scraping data on Ronaldo goals in competitions.*
```{r}
ronaldoClubStatsURL <- "https://www.transfermarkt.us/cristiano-ronaldo/detaillierteleistungsdaten/spieler/8198"
```

```{r}
ronaldoClubStatsPage <- read_html(ronaldoClubStatsURL)
```

```{r}
ronaldoTable.html <- html_nodes(ronaldoClubStatsPage, "table")
```

```{r}
ronaldoLaLiga <- html_table(ronaldoTable.html[[1]], fill = TRUE) %>% as_tibble(.name_repair = "unique")

ronaldoLaLiga <- ronaldoLaLiga %>% select(Season, Club, ...6, ...7) %>% rename(Appearances = "Club", Goals = "...6", Assists = "...7") %>% drop_na() %>% slice(3:11)
ronaldoLaLiga <- ronaldoLaLiga %>%
  mutate(Player = "Ronaldo")
```

*Join the Messi and Ronaldo datasets for each competition*
```{r}
#LaLiga
messiAndRonaldoLaLiga <- rbind(messiLaLiga, ronaldoLaLiga)%>%
  select(Season, Player, Appearances, Goals, Assists)
```

```{r}
write_csv(messiAndRonaldoLaLiga, "messiAndRonaldoLaLiga.csv")
```

```{r}
messiChampionsLeague <-  html_table(messiTable.html[[3]], fill = TRUE) %>% as_tibble(.name_repair = "unique")

messiChampionsLeague <- messiChampionsLeague %>% select(Season, Club,...6, ...7) %>% rename(Appearances = "Club", Goals = "...6", Assists = "...7") %>% drop_na() %>% slice(3:19)

messiChampionsLeague <- messiChampionsLeague %>% slice(-(c(4,5,10,11,14,15,17)))%>%
  mutate(Player = "Messi")
```

```{r}
ronaldoChampionsLeague <-  html_table(ronaldoTable.html[[3]], fill = TRUE) %>% as_tibble(.name_repair = "unique")

ronaldoChampionsLeague <- ronaldoChampionsLeague %>% select(Season, Club,...6, ...7) %>% rename(Appearances = "Club", Goals = "...6", Assists = "...7") %>% drop_na() %>% slice(3:19)

ronaldoChampionsLeague <- ronaldoChampionsLeague %>% slice(-(c(2,3,5,8,9,16,17)))%>%
  mutate(Player = "Ronaldo")
```

```{r}
#ChampionsLeague
messiAndRonaldoUEFA <- rbind(messiChampionsLeague, ronaldoChampionsLeague)%>%
  mutate(Assists = parse_number(Assists) )
```

```{r}
write_csv(messiAndRonaldoUEFA, "messiAndRonaldoUEFA.csv")
```

##Statistical Learning on the Dataset

###Fitting a Random Forests Model on the Dataset `MessiRonaldoComplete` 

###Converting all binary variables from character to factors. Taking out All the total stats because they are just the sum of the club and country stats.
```{r}
MessiRonaldoComplete1<- read.csv("MessiRonaldoComplete.csv") %>%
  select(-MTotAssists, -MTotGoals,- MTotApps, - RTotAssists, - RTotGoals, - RTotApps)
```

*Splitting the training data into a training subset and a test subset.*

```{r Training/Test Split}
set.seed(757302859)
n <- nrow(MessiRonaldoComplete1)
train_index <- sample(n, size=round(.8*n))
BDor_train <- MessiRonaldoComplete1 %>% slice(train_index)
BDor_test <- MessiRonaldoComplete1 %>% slice(-train_index)
```

###Tuning the value of mtry.

```{r Tuning Random Forest With All Variables}
set.seed(757302850)
train_control <- trainControl(
  method = "cv",   # cross-validation 
  number = 10     # 10-folds
)
randomforest_cv <- train(
  BallonDor ~ .,            # predict election winner using all other variables in training
  data = BDor_train,    # training data
  method = "rf",           # classification method
  tuneGrid = data.frame(mtry = seq(6,10, by = 1)),
  trControl = train_control    # validation method
)
randomforest_cv
```

```{r Random Forest With All Variables}
set.seed(2242021)
BallonDor_rforest <- randomForest(BallonDor ~ ., 
                                 data=BDor_train,
                                 ntree=200, 
                                 mtry = 10)
BallonDor_rforest
```

```{r Variable Importance Plot}
varImpPlot(BallonDor_rforest)
```

```{r RF Confirmation Matrix All Variables}
confm_test <- confusionMatrix(
  data = predict(BallonDor_rforest, newdata=BDor_test), 
  reference = BDor_test$BallonDor, 
  positive = "Messi" )
confm_test$table
confm_test$byClass
```

*Taking out the Domestic Cup Variable because it is not important in determining who wins Ballon D'or.*

###Tuning the value of mtry.

```{r Tuning Random Forest Without Domestic Cups}
set.seed(757302)
train_control <- trainControl(
  method = "cv",   # cross-validation 
  number = 10     # 10-folds
)
randomforest_cv1 <- train(
  BallonDor ~ MClubApps + MClubAssists + MClubGoals+ MCoApps  + MCoAssists +MCoGoals + MDomesticCup + MEuropeanCup + MLeague + RClubApps + RClubAssists + RClubGoals   + RCoApps + RCoAssists + RCoGoals + RDomesticCup+ REuropeanCup + RLeague+ Year,            # predict election winner using all other variables in training
  data = BDor_train,    # training data
  method = "rf",           # classification method
  tuneGrid = data.frame(mtry = seq(6,10, by = 1)),
  trControl = train_control    # validation method
)
randomforest_cv1
```

```{r Random Forest Without Domestic Cups}
set.seed(2242)
BallonDor_rforest1 <- randomForest(BallonDor ~ MClubApps + MClubAssists + MClubGoals+ MCoApps  + MCoAssists +MCoGoals + MDomesticCup + MEuropeanCup + MLeague + RClubApps + RClubAssists + RClubGoals   + RCoApps + RCoAssists + RCoGoals + RDomesticCup+ REuropeanCup + RLeague+ Year , 
                                 data=BDor_train,
                                 ntree=200, 
                                 mtry = 10)
BallonDor_rforest1
```

```{r Variable Importance Plot}
varImpPlot(BallonDor_rforest1)
```

```{r RF Confirmation Matrix without Domestic Cup}
confm_test <- confusionMatrix(
  data = predict(BallonDor_rforest, newdata=BDor_test), 
  reference = BDor_test$BallonDor, 
  positive = "Messi" )
confm_test$table
confm_test$byClass
```

*Trying a different type of statistical learning method*

###Logistic Regression

```{r}
BDor_logistic <- glm(BallonDor~ ., data=BDor_train, family = binomial)
```

```{r}
BDor_test2 <- BDor_test %>% 
  mutate(prob = predict(BDor_logistic , newdata = BDor_test, type = "response"),
         prediction = ifelse(prob > 0.5, "Messi", "Ronaldo"),
         prediction = fct_relevel(prediction, "Ronaldo", "Messi"))
```

###Determining the appropriate threshold level that maximizes accuracy. 
```{r}
t <- seq(0.05, 0.95, by = 0.05)
eval_fun <- function(t, test) 
  {test %>%
  mutate(prediction = ifelse( prob > t, "Messi", "Ronaldo") ) %>%
  summarize(threshold=t, 
            accuracy = mean(prediction == BallonDor), 
            sensitivity = sum(prediction == "Messi" & BallonDor == "Messi")/sum(BallonDor == "Messi"),
            specificity = sum(prediction == "Ronaldo" & BallonDor == "Ronaldo")/sum(BallonDor == "Ronaldo"),
            precision = sum(prediction == "Messi" & BallonDor == "Messi")/sum(prediction == "Messi"))
}
eval_df <- map_df(t, eval_fun, test = BDor_test2)
glimpse(eval_df)
```

All thresholds return the same value of accuracy, precision, sensitivity, and specificity. Therefore, we are using the threshold of 0.5. Also since we are getting correct predictions based on a Logistic Regression Model with all our variables, that is the model we will use to predict who should win the Ballon D'or. 

